<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Local 3D Tiles Viewer</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.121/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.121/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
            display: flex;
        }
        #cesiumContainer {
            flex: 1;
            height: 100%;
            max-width: 70%;
        }
        #sidebar {
            width: 30%;
            height: 100vh;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            background: white;
            border-left: 1px solid #ccc;
            flex-shrink: 0;
        }
        #tilesFileInput {
            width: 100%;
            margin-bottom: 10px;
        }
        .layer-item {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            margin-bottom: 5px;
        }
        .layer-controls {
            display: flex;
            align-items: center;
        }
        .layer-controls label {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="sidebar">
        <h2>3D Tiles Viewer</h2>
        <div style="margin-bottom: 15px;">
            <input type="text" id="colorExpression" value="gml_id" placeholder="Property expression">
        </div>
        <div id="layersSection">
            <h3>Layers</h3>
            <div id="layersList"></div>
        </div>
    </div>
    <script>
        let viewer;
        let layerIdCounter = 0;
        const layers = new Map(); // Map of layer ID to { tileset, color, urlInput, checkbox }
        let colorExpression = 'gml_id'; // Expression to use for coloring

        // Injected tile list
        const tilesetUrls = {{TILES_LIST}};

        (async function() {
            viewer = new Cesium.Viewer('cesiumContainer', {
                terrainProvider: undefined
            });

            // Setup color expression input (Enter to apply)
            const colorExpressionInput = document.getElementById('colorExpression');
            colorExpressionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    colorExpression = colorExpressionInput.value;
                    layers.forEach(layerData => {
                        if (layerData.tileset) {
                            applyTilesetStyle(layerData.tileset);
                        }
                    });
                }
            });

            // Load all tilesets
            for (let i = 0; i < tilesetUrls.length; i++) {
                const url = tilesetUrls[i];
                const result = await createTilesetLayer(url, i);
                if (result) {
                    const { layerId, tileset } = result;
                    const { urlInput, checkbox } = addLayerUI(layerId, url, true);
                    layers.set(layerId, { tileset, urlInput, checkbox });
                    tileset.show = true;
                }
            }

            // Zoom to first tileset if available
            if (tilesetUrls.length > 0) {
                const firstLayer = Array.from(layers.values())[0];
                if (firstLayer && firstLayer.tileset) {
                    viewer.zoomTo(firstLayer.tileset);
                }
            }
        })();

        async function createTilesetLayer(url, colorIndex) {
            const layerId = layerIdCounter++;
            try {
                const tileset = await Cesium.Cesium3DTileset.fromUrl(url);
                applyTilesetStyle(tileset);
                viewer.scene.primitives.add(tileset);
                return { layerId, tileset };
            } catch (error) {
                console.error(`Failed to load tileset from ${url}:`, error);
                return null;
            }
        }

        // MurmurHash3 finalizer â€” maps a string to a stable uint32
        function hashString(str) {
            let h = 0x811c9dc5; // FNV offset basis as seed
            for (let i = 0; i < str.length; i++) {
                h = Math.imul(h ^ str.charCodeAt(i), 0x01000193); // FNV prime
            }
            // Avalanche (MurmurHash3 mix)
            h ^= h >>> 16;
            h = Math.imul(h, 0x85ebca6b) | 0;
            h ^= h >>> 13;
            h = Math.imul(h, 0xc2b2ae35) | 0;
            h ^= h >>> 16;
            return h >>> 0; // unsigned 32-bit
        }

        // Function to evaluate property expression
        function evaluateExpression(feature, expression) {
            if (!expression) return '';

            // Handle dot notation and array indices like .foo.bar[0].baz
            const path = expression.replace(/^\./, '').replace(/\[(\d+)\]/g, '.$1');
            const parts = path.split('.');

            let value = feature;
            for (const part of parts) {
                if (value && typeof value === 'object') {
                    value = value.getProperty ? value.getProperty(part) : value[part];
                } else {
                    return '';
                }
            }

            return String(value || '');
        }

        // Function to apply style to tileset
        function applyTilesetStyle(tileset) {
            if (!colorExpression || !colorExpression.trim()) {
                tileset.style = undefined;
                return;
            }

            tileset.style = new Cesium.Cesium3DTileStyle({
                color: {
                    evaluateColor: function(feature, result) {
                        const value = evaluateExpression(feature, colorExpression);
                        if (!value) {
                            return undefined;
                        }
                        const hue = hashString(value) % 360;
                        return Cesium.Color.fromHsl(hue / 360, 0.7, 0.5, 1.0, result);
                    }
                }
            });
        }

        // Function to add layer UI
        function addLayerUI(layerId, url, visible = true) {
            const layerItem = document.createElement('div');
            layerItem.className = 'layer-item';
            layerItem.id = `layer-${layerId}`;

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'layer-controls';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = visible;
            checkbox.addEventListener('change', () => {
                const layerData = layers.get(layerId);
                if (layerData && layerData.tileset) {
                    layerData.tileset.show = checkbox.checked;
                }
            });
            controlsDiv.appendChild(checkbox);
            const urlInput = document.createElement('input');
            urlInput.type = 'text';
            urlInput.value = url;
            urlInput.placeholder = 'Tileset URL';
            urlInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    const layerData = layers.get(layerId);
                    if (layerData && layerData.tileset) {
                        viewer.scene.primitives.remove(layerData.tileset);
                        try {
                            const newTileset = await Cesium.Cesium3DTileset.fromUrl(e.target.value);
                            applyTilesetStyle(newTileset);
                            viewer.scene.primitives.add(newTileset);
                            layerData.tileset = newTileset;
                            layerData.tileset.show = checkbox.checked;
                        } catch (error) {
                            console.error('Failed to load new tileset:', error);
                            alert('Failed to load tileset: ' + error.message);
                        }
                    }
                }
            });

            layerItem.appendChild(controlsDiv);
            layerItem.appendChild(urlInput);
            document.getElementById('layersList').appendChild(layerItem);
            return { urlInput, checkbox };
        }
    </script>
</body>
</html>
